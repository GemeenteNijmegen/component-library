# ======================
# CI Stages
# ======================

stages:
  - build
  - deploy

# ======================
# Global variables
# ======================

variables:
  DOCKER_DRIVER: overlay2
  BASE_VERSION: "1.0."
  EXTERNAL_DOCKER_HOST: tcp://localhost:5099
  SERVICE_NAME: componentlibrary

build:
  stage: build
  services:
    - docker:dind
  before_script:
    - if [ "$CI_COMMIT_REF_SLUG" = "master" ]; then
        export DOCKER_TAG="$BASE_VERSION$CI_PIPELINE_ID";
      else
        export DOCKER_TAG="$CI_COMMIT_REF_SLUG";
      fi;
    - apk --no-cache add python py-pip
    - pip install --upgrade docker-compose
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker-compose -f docker-compose-prod.yml build
    - docker-compose -f docker-compose-prod.yml push

deploy:
  stage: deploy
  services:
    - docker:dind
  before_script:
    - if [ "$CI_COMMIT_REF_SLUG" = "master" ]; then
        export DOCKER_TAG="$BASE_VERSION$CI_PIPELINE_ID";
      else
        export DOCKER_TAG="$CI_COMMIT_REF_SLUG";
      fi;
    - apk --no-cache add openssh
    # Run ssh-agent (inside the build environment)
    - eval $(ssh-agent -s)
    # Add the SSH key stored in SSH_PRIVATE_KEY variable to the agent store
#    - ssh-add <(echo "$SSH_PRIVATE_KEY")

    - echo "$SSH_PRIVATE_KEY"
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
    - mkdir /root/.ssh/
    - ssh-keyscan -H 'acc01.nijmegen.cobytes.io' >> ~/.ssh/known_hosts
    - ssh-keyscan -H 'jump01.nijmegen.cobytes.io' >> ~/.ssh/known_hosts
#    - echo $SSH_PRIVATE_KEY | tr -d '\r' > /root/.ssh/id_rsa
#    - chmod 600 /root/.ssh/id_rsa && chmod 700 /root/.ssh
#    - ssh-add /root/.ssh/id_rsa
  script:
    - ssh -v -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -o ProxyCommand="ssh -W %h:%p -q enrise@jump01.nijmegen.cobytes.io" -M -S docker-socket -fnNT -L 5099:/var/run/docker/libcontainerd/docker-containerd.sock enrise-docker-deploy@acc01.nijmegen.cobytes.io
    - ssh -S docker-socket -O check enrise-docker-deploy@acc01.nijmegen.cobytes.io
    - DOCKER_HOST=$EXTERNAL_DOCKER_HOST docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - DOCKER_HOST=$EXTERNAL_DOCKER_HOST docker stack deploy --with-registry-auth --compose-file=docker-compose-prod.yml ${SERVICE_NAME}
    - ssh -S docker-socket -O exit enrise-docker-deploy@acc01.nijmegen.cobytes.io
#  only:
#    - master
