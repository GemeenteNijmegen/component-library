<script>
    var searchUrl = 'https://public.pandosearch.com/nijmegen.nl/search';

    function Pandosearch(itemsPerPage = 5) {
        this.baseSearchUrl;
        this.searchUrl;
        this.query;
        this.currentPage;
        this.itemsPerPage = itemsPerPage;
        this.totalHits = 0;
        this.searchResultsComponent = new SearchResults();
        this.paginationContainer = $('#search-results-pagination');
    }

    Pandosearch.prototype.init = function (baseSearchUrl) {
        this.baseSearchUrl = baseSearchUrl;
        this.searchResultsComponent.init();
    }

    Pandosearch.prototype.show = function (currentPage = 1) {
        this.currentPage = currentPage;
        this.buildSearchUrl();

        try {
            $.get(this.searchUrl, this.showResults.bind(this));
        } catch (error) {
            throw new Error(`Pandosearch: failed fetching data with error ${error}`);
        }
    }

    Pandosearch.prototype.buildSearchUrl = function () {
        var url = new URL(window.location.href);
        this.query = url.searchParams.get('q');

        this.searchUrl = this.baseSearchUrl + '?size=' + this.itemsPerPage + '&page=' + this.currentPage + '&q=' + this.query;
    }

    Pandosearch.prototype.showResults = function (rawResults) {
        var hits = this.getHits(rawResults);

        var didYouMeanTerm;
        if (!hits.length) {
            didYouMeanTerm = this.getDidYouMeanTerm(rawResults);
            hits = didYouMeanTerm ? this.getDidYouMeanHits(rawResults) : [];
        }
        this.searchResultsComponent.show(hits, this.query, didYouMeanTerm);

        if (hits.length) {
            var pagination = new Pagination(this.getNumberOfPages(), '#{page}', 5);
            pagination.init(this.paginationContainer);
            pagination.show(this.currentPage);
        } else {
            this.paginationContainer.hide();
        }
    }

    Pandosearch.prototype.getHits = function (rawResults) {
        this.totalHits = rawResults.total;
        return Array.isArray(rawResults.hits) ?
                rawResults.hits.map(hit => ({
                    title: hit.fields.title,
                    body: hit.fields.body ? hit.fields.body : '---',
                    url: hit.url
                })) : [];
    }

    Pandosearch.prototype.getDidYouMeanTerm = function (rawResults) {
        return rawResults.suggestions ? rawResults.suggestions.didyoumean.text : null;
    }

    Pandosearch.prototype.getDidYouMeanHits = function (rawResults) {
        this.totalHits = rawResults.suggestions.didyoumean.result.total;
        return rawResults.suggestions.didyoumean.result.hits.map(hit => ({
            title: hit.fields.title,
            body: hit.fields.body ? hit.fields.body : '---',
            url: hit.url
        }));
    }

    Pandosearch.prototype.getNumberOfPages = function () {
        return Math.ceil(this.totalHits / this.itemsPerPage);
    }

    var pandosearch = new Pandosearch();
    $(document).ready(function () {
        pandosearch.init(searchUrl);
        pandosearch.show(1);

        $(window).on('hashchange', function () {
            var page = parseInt(window.location.hash.slice(1));
            pandosearch.show(page);
        });

        $('#suggest-search-query').val(pandosearch.query);
    });
</script>
